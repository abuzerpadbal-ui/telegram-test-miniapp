<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mijoz Test Panel</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6ff;
}
.container {
  max-width: 900px;
  margin: auto;
  background: white;
  padding: 20px;
  border-radius: 10px;
}
.hidden { display: none; }
input, button {
  padding: 10px;
  margin: 5px 0;
  width: 100%;
}
.variants button {
  width: 48%;
  margin: 3px 1%;
}
.active {
  background: #4caf50;
  color: white;
}
.result {
  background: #e3f2fd;
  padding: 10px;
  border-radius: 8px;
}
</style>
</head>
<body>

<div class="container">

<h2>Mijoz test topshirish</h2>

<!-- TEST CODE -->
<div id="codePanel">
  <input type="number" id="testCodeInput" placeholder="Test kodini kiriting">
  <button onclick="sendTestCode()">Testni boshlash</button>
</div>

<!-- QUESTION -->
<div id="questionPanel" class="hidden">
  <h3 id="qTitle"></h3>

  <div class="variants">
    <button onclick="selectVariant('A')">A</button>
    <button onclick="selectVariant('B')">B</button>
    <button onclick="selectVariant('C')">C</button>
    <button onclick="selectVariant('D')">D</button>
    <button onclick="selectVariant('E')">E</button>
  </div>

  <input
    type="text"
    id="written"
    placeholder="Yozma javob (masalan: 2 va 3 yoki xÂ²+1)"
    oninput="writtenInput()"
  >

  <button onclick="nextQuestion()">Keyingi</button>
</div>

<!-- RESULT -->
<div id="resultPanel" class="hidden">
  <h3>Natija</h3>
  <div id="resultText" class="result"></div>
</div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

let adminData = null;
let current = 0;
let userAnswers = [];
let selectedVariant = null;
let totalQuestions = 0;
let perQuestionScore = 0;
let score = 0;

/* TEST CODE SEND */
function sendTestCode() {
  const code = document.getElementById("testCodeInput").value;
  if (!code) {
    alert("Test kodini kiriting!");
    return;
  }

  tg.sendData(JSON.stringify({
    role: "user",
    test_code: code
  }));
}

/* ADMIN DATA QABUL QILISH */
tg.onEvent("message", function() {
  const data = JSON.parse(tg.initDataUnsafe?.web_app_data?.data || "{}");

  if (!data.questions) return;

  adminData = data;
  totalQuestions = adminData.questions.length;
  perQuestionScore = 800 / totalQuestions;

  document.getElementById("codePanel").classList.add("hidden");
  document.getElementById("questionPanel").classList.remove("hidden");

  showQuestion();
});

/* QUESTION */
function showQuestion() {
  document.getElementById("qTitle").innerText =
    `Savol ${current + 1} / ${totalQuestions}`;
  document.getElementById("written").value = "";
  enableVariants(true);
  selectedVariant = null;
}

function selectVariant(v) {
  selectedVariant = v;
  document.getElementById("written").disabled = true;

  document.querySelectorAll(".variants button").forEach(b => {
    b.classList.remove("active");
    if (b.innerText === v) b.classList.add("active");
  });
}

function writtenInput() {
  const input = document.getElementById("written");
  if (input.value.length > 0) {
    enableVariants(false);
    selectedVariant = null;
  } else {
    enableVariants(true);
  }
}

function enableVariants(enable) {
  document.querySelectorAll(".variants button").forEach(b => {
    b.disabled = !enable;
    b.classList.remove("active");
  });
  document.getElementById("written").disabled = !enable;
}

/* NEXT */
function nextQuestion() {
  userAnswers.push({
    variant: selectedVariant,
    written: document.getElementById("written").value.trim()
  });

  checkAnswer();

  current++;
  if (current >= totalQuestions) {
    showResult();
  } else {
    showQuestion();
  }
}

/* ANSWER CHECK */
function checkAnswer() {
  const adminQ = adminData.questions[current];
  const userQ = userAnswers[current];

  let correct = false;

  // Variant tekshirish
  if (adminQ.variant && adminQ.variant === userQ.variant) {
    correct = true;
  }

  // Written tekshirish (va bilan)
  if (adminQ.written_answers && userQ.written) {
    const parts = userQ.written
      .split("va")
      .map(p => p.trim());

    for (let p of parts) {
      if (adminQ.written_answers.includes(p)) {
        correct = true;
      }
    }
  }

  if (correct) {
    score += perQuestionScore;
  }
}

/* RESULT */
function showResult() {
  document.getElementById("questionPanel").classList.add("hidden");
  document.getElementById("resultPanel").classList.remove("hidden");

  document.getElementById("resultText").innerHTML =
    `Sizning natijangiz: <b>${Math.round(score)} / 800</b>`;
}
</script>

</body>
</html>
