<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mijoz Test Panel</title>

<style>
body { font-family: Arial, sans-serif; background: #f4f6ff; }
.container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
.hidden { display: none; }
input, button { padding: 10px; margin: 5px 0; width: 100%; }
.variants button { width: 48%; margin: 3px 1%; }
.active { background: #4caf50; color: white; }
.result { background: #e3f2fd; padding: 10px; margin-top: 10px; border-radius: 5px; }
.correct { color: green; font-weight: bold; }
.wrong { color: red; font-weight: bold; }
</style>
</head>

<body>
<div class="container">

<h2>Test ishlash</h2>

<div id="questionPanel">
  <h3 id="qTitle"></h3>

  <div class="variants">
    <button onclick="selectVariant('A')">A</button>
    <button onclick="selectVariant('B')">B</button>
    <button onclick="selectVariant('C')">C</button>
    <button onclick="selectVariant('D')">D</button>
    <button onclick="selectVariant('E')">E</button>
  </div>

  <input type="text" id="written" placeholder="Yozma javob (agar kerak bo‘lsa)" oninput="writtenInput()">

  <button onclick="nextQuestion()">Keyingi savol</button>
</div>

<div id="resultPanel" class="hidden">
  <h3>Natija</h3>
  <div id="results"></div>
</div>

</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

/* =========================
   ADMIN TESTNI QABUL QILISH
========================= */

const payload = JSON.parse(tg.initDataUnsafe.start_param);
const adminTest = payload.test;
const testCode = payload.testCode;

let total = adminTest.length;
let current = 0;
let userAnswers = [];
let selectedVariant = null;

/* ========================= */

function showQuestion() {
  document.getElementById("qTitle").innerText = `Savol ${current + 1} / ${total}`;
  document.getElementById("written").value = "";
  selectedVariant = null;
  enableVariants(true);
}

function selectVariant(v) {
  selectedVariant = v;
  document.getElementById("written").value = "";
  document.getElementById("written").disabled = true;
  highlightVariant(v);
}

function writtenInput() {
  const input = document.getElementById("written");
  let val = input.value.trim();

  if (val.length > 0) {
    enableVariants(false);
    selectedVariant = null;

    val = val
      .toLowerCase()
      .split(" va ")
      .map(v => v.trim())
      .filter(v => v)
      .join(" va ");

    input.value = val;
  } else {
    enableVariants(true);
  }
}

function enableVariants(enable) {
  document.querySelectorAll(".variants button").forEach(b => {
    b.disabled = !enable;
    b.classList.remove("active");
  });
  document.getElementById("written").disabled = !enable;
}

function highlightVariant(v) {
  document.querySelectorAll(".variants button").forEach(b => {
    if (b.innerText === v) b.classList.add("active");
    else b.classList.remove("active");
  });
}

function nextQuestion() {
  const written = document.getElementById("written").value.trim();

  if (!selectedVariant && !written) {
    alert("Javob bering!");
    return;
  }

  userAnswers.push({
    variant: selectedVariant,
    written: written
  });

  current++;
  if (current >= total) {
    showResults();
  } else {
    showQuestion();
  }
}

function normalizeText(t) {
  return t
    .toLowerCase()
    .split(" va ")
    .map(v => v.trim())
    .filter(v => v)
    .join(" va ");
}

function showResults() {
  document.getElementById("questionPanel").classList.add("hidden");
  document.getElementById("resultPanel").classList.remove("hidden");

  let resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  let score = 0;
  const maxScore = 800;
  const perQuestion = Math.floor(maxScore / total);

  for (let i = 0; i < total; i++) {
    const admin = adminTest[i];
    const user = userAnswers[i];

    let correct = false;

    if (admin.variant) {
      correct = admin.variant === user.variant;
    } else {
      correct = normalizeText(admin.written) === normalizeText(user.written);
    }

    if (correct) score += perQuestion;

    resultsDiv.innerHTML += `
      <div class="result">
        <b>Savol ${i+1}</b><br>
        Admin javobi: ${admin.variant || admin.written}<br>
        Sizning javobingiz: ${user.variant || user.written}<br>
        Holat:
        <span class="${correct ? 'correct' : 'wrong'}">
          ${correct ? '✅ To‘g‘ri' : '❌ Xato'}
        </span>
      </div>
    `;
  }

  resultsDiv.innerHTML += `<h3>Umumiy ball: ${score} / ${maxScore}</h3>`;

  tg.sendData(JSON.stringify({
    testCode,
    answers: userAnswers,
    score
  }));
}

/* BOSHLASH */
showQuestion();
</script>
</body>
</html>
